  <script>
// var parseTime = d3.timeParse("%Y%m%d");

  var networkOutputBinding = new Shiny.OutputBinding();
  $.extend(networkOutputBinding, {
    find: function(scope) {
      return $(scope).find('.shiny-network-output');
    },
    renderValue: function(el, data) {
    	if(!data) return;
      console.log(data);
      // console.log("I am here");
      var svg = d3.select("svg"),
      margin = {top: 20, right: 80, bottom: 30, left: 50},
      width = svg.attr("width") - margin.left - margin.right,
      height = svg.attr("height") - margin.top - margin.bottom,
      g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var x = d3.scaleLog().range([0, width]),
	y = d3.scaleLinear().range([height, 0]),
	z = d3.scaleOrdinal(d3.schemeCategory10);
	var line = d3.line()
	.curve(d3.curveBasis)
	.x(function(d) { console.log("psize:"+d.psize+";; x = "+x(d.psize)); return x(d.psize); })
	.y(function(d) { return y(d.frequency); });


      	// Hover line. 
	var hoverLineGroup = svg.append("g")
	.attr("class", "hover-line");
	var hoverLine = hoverLineGroup
	.append("line")
	.attr("x1", 0).attr("x2", 0) 
	.attr("y1", 0).attr("y2", height); 

	var hoverText = hoverLineGroup.append('text')
	.attr("class", "hover-text")
	.attr('y', 20);

	var lineHeight = 40;
	// Hide hover line by default.
	hoverLineGroup.style("opacity", 1e-6);

      // console.log("I am here");
	  var size = data.size;
	  var cities = []
	  for(xx in data){
	  	if(xx=="size") continue;
	  	var myobj = {id: xx, values: []}
	  	for(var i=0; i<size.length; i++){
	  		myobj.values.push({psize: parseFloat(size[i]), frequency: data[xx][i]})
	  	}
	  	cities.push(myobj);
	  }

// console.log(cities);
		x.domain(d3.extent(data.size, function(d) { console.log("X : "+d); return d; }));

		y.domain([
		  d3.min(cities, function(c) { return d3.min(c.values, function(d) { return d.frequency; }); }),
		  d3.max(cities, function(c) { return d3.max(c.values, function(d) { return d.frequency; }); })
		  ]);

		z.domain(cities.map(function(c) { return c.id; }));

		g.append("g")
		.attr("class", "axis axis--x")
		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x));

		g.append("g")
		.attr("class", "axis axis--y")
		.call(d3.axisLeft(y))
		.append("text")
		.attr("transform", "rotate(-90)")
		.attr("y", 6)
		.attr("dy", "0.71em")
		.attr("fill", "#000")
		.text("Frequency");

		var city = g.selectAll(".city")
		.data(cities)
		.enter().append("g")
		.attr("class", "city");

		city.append("path")
		.attr("class", "line")
		.attr("d", function(d) { return line(d.values); })
		.style("stroke", function(d) { return z(d.id); });

		city.append("text")
		.datum(function(d) { return {id: d.id, value: d.values[d.values.length - 1]}; })
		.attr("transform", function(d) { console.log(d.value); return "translate(" + x(d.value.psize) + "," + y(d.value.frequency) + ")"; })
		.attr("x", 3)
		.attr("dy", "0.35em")
		.style("font", "10px sans-serif")
		.text(function(d) { return d.id; });

// });

// function type(d, _, columns) {
//   d.psize = parseFloat(d.particle_size);
//   for (var i = 1, n = columns.length, c; i < n; ++i) d[c = columns[i]] = +d[c];
//   	// console.log(d);
//   return d;
// }

/*var lines = {"counter":0}
var clickCounts = 0;
var lineCounts = 0;*/
  // Add mouseover events.
// d3.select("svg").on("mousemove", function() {
// 	if(lines.counter >= 3) return;
// 	//console.log('mousemove', d3.mouse(this));
// 	var mouse_x = d3.mouse(this)[0];
// 	var mouse_y = d3.mouse(this)[1];

// 	// var graph_y = y.invert(mouse_y);
// 	var graph_x = x.invert(mouse_x);
// 	// console.log(mouse_x + " " + mouse_y + " " + graph_y + " " + graph_x);
// 	var char = "A", counter = 0;
// 	if(!lines.A){char="A"; }
// 	else if(!lines.B){char="B"; counter=1;}
// 	else if(!lines.C){char="C"; counter=2;}

// 	hoverLine.attr("x1", mouse_x).attr("x2", mouse_x);
// 	hoverText.text("("+char+") "+graph_x)
// 		.attr('y', 20 + lineHeight*counter);
// 	// hoverText.text(graph_x);
//   	hoverText.attr('x', mouse_x);
// 	hoverLineGroup.style("opacity", 1);

// 	// d3.select(this).select("text").append(mouse_x + " " + mouse_y)
// 	// .style("visibility", "visible");
// 	//console.log(graph_x);
// 	//var format = d3.time.format('%e %b');
// 	//format.parse(graph_x
// }).on("mouseout", function() {
//     // console.log('mouseout');
//     hoverLineGroup.style("opacity", 1e-6);
// }).on('click', function(){
// 	if(lines.counter >= 3) return;
// 	var mouse_x = d3.mouse(this)[0];
// 	// var mouse_y = d3.mouse(this)[1];

// 	// var graph_y = y.invert(mouse_y);
// 	var graph_x = x.invert(mouse_x);

// 	var lineGroup = svg.append("g").attr("class", "hover-line");

// 	var char = "A", counter = 0;
// 	if(!lines.A){lines.A = lineGroup; char="A"; }
// 	else if(!lines.B){lines.B = lineGroup; char="B"; counter=1;}
// 	else if(!lines.C){lines.C = lineGroup; char="C"; counter=2;}

// 	var line = lineGroup
// 		.append("line")
// 		.attr("x1", mouse_x).attr("x2", mouse_x) 
// 		.attr("y1", 0).attr("y2", height); 
// 	// console.log(mouse_x + " " + graph_x);
// 	var text = lineGroup.append('text')
// 	   .attr("class", "hover-text")
// 	   .attr('y', 20 + lineHeight*counter)
// 	   .attr('x', mouse_x)
// 	   .text("("+char+") "+graph_x);

// 	text.on("dblclick", function(){
// 			lineGroup.remove();
// 			lines.counter--;
// 			delete lines[char];
// 		})
// 	lines.counter++;
// });
}
})
Shiny.outputBindings.register(networkOutputBinding, 'alexwhan.networkbinding');
</script>
